<!DOCTYPE html>
<!-- 
水浒传108好汉匹配游戏
版本：1.0
创建时间：2023年10月
功能说明：通过匹配好汉姓名与江湖别称，帮助玩家熟悉水浒传108好汉的相关知识
         包含多种游戏模式选择，历史记录保存与导出功能
-->
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水浒传108好汉匹配游戏</title>
    <!-- 引入Tailwind CSS (使用HTTPS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome (使用HTTPS) -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义颜色 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#9b2226',      // 主色调-深红色（别称卡片）
                        secondary: '#0f766e',    // 辅助色-深绿色（姓名卡片）
                        warning: '#bb3e03',      // 警告色-棕色（倒计时警告）
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-selected {
                transform: scale(1.08);
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            .card-matched {
                animation: pulse 0.5s;
            }
            .timer-warning {
                animation: warning 1s infinite alternate;
            }
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.15); }
            }
            @keyframes warning {
                from { color: #bb3e03; }
                to { color: #9b2226; }
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-amber-50 to-orange-50 min-h-screen font-sans">
    <!-- 固定宽度容器 -->
    <div class="w-[1000px] mx-auto px-4 py-5">
        <!-- 游戏标题和信息 -->
        <header class="text-center mb-5">
            <h1 class="text-2.5rem font-bold text-gray-800 mb-2 tracking-tight">
                水浒传<span class="text-primary">108好汉</span>匹配游戏
            </h1>
            <p class="text-gray-600 mb-4 max-w-2xl mx-auto">
                匹配好汉姓名与江湖别称，提升古典文学知识
            </p>
            
            <!-- 游戏设置区域 -->
            <div class="mb-5 bg-white rounded-lg shadow-md p-3 max-w-3xl mx-auto grid grid-cols-3 gap-4">
                <!-- 好汉数量选择器 -->
                <div>
                    <label for="heroCount" class="block text-gray-700 text-sm font-medium mb-1.5">选择好汉数量:</label>
                    <div class="flex items-center">
                        <select id="heroCount" class="flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
                            <option value="5">5位好汉</option>
                            <option value="10">10位好汉</option>
                            <option value="15">15位好汉</option>
                            <option value="20">20位好汉</option>
                            <option value="25" selected>25位好汉</option>
                        </select>
                    </div>
                </div>
                
                <!-- 计时方式选择器 -->
                <div>
                    <label for="timingMode" class="block text-gray-700 text-sm font-medium mb-1.5">选择计时方式:</label>
                    <div class="flex items-center">
                        <select id="timingMode" class="flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
                            <option value="timed">计时模式</option>
                            <option value="countdown">倒计时模式</option>
                            <option value="untimed">无计时模式</option>
                        </select>
                    </div>
                </div>
                
                <!-- 倒计时时长设置 -->
                <div id="countdownSettings">
                    <label for="countdownDuration" class="block text-gray-700 text-sm font-medium mb-1.5">倒计时时长(秒):</label>
                    <div class="flex items-center">
                        <input type="number" id="countdownDuration" min="30" max="300" value="120" 
                               class="flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
                    </div>
                </div>
            </div>
            
            <div class="flex justify-center gap-3 mb-5">
                <div id="timerContainer" class="bg-white rounded-lg shadow-md px-3 py-2 flex items-center">
                    <i class="fa fa-clock-o text-primary mr-1.5"></i>
                    <span class="text-gray-700" id="timerLabel">时间: </span>
                    <span id="timer" class="font-semibold ml-1.5">00:00</span>
                </div>
                
                <div class="bg-white rounded-lg shadow-md px-3 py-2 flex items-center">
                    <i class="fa fa-hand-pointer-o text-primary mr-1.5"></i>
                    <span class="text-gray-700">尝试次数: </span>
                    <span id="attempts" class="font-semibold ml-1.5">0</span>
                </div>
                
                <div class="bg-white rounded-lg shadow-md px-3 py-2 flex items-center">
                    <i class="fa fa-check-circle text-primary mr-1.5"></i>
                    <span class="text-gray-700">匹配: </span>
                    <span id="matches" class="font-semibold ml-1.5">0/0</span>
                </div>
            </div>
            
            <div class="flex justify-center gap-3">
                <button id="startBtn" class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-5 rounded-lg shadow-md transition-all duration-300 focus:outline-none">
                    开始游戏
                </button>
                <button id="historyBtn" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-5 rounded-lg shadow-md transition-all duration-300 focus:outline-none">
                    查看历史
                </button>
            </div>
        </header>
        
        <!-- 游戏区域 - 固定每行5个卡片，增加高度防止重叠 -->
        <div class="grid grid-cols-2 gap-6 mb-5">
            <!-- 左侧：好汉姓名卡片区域 -->
            <div id="nameContainer" class="opacity-50 pointer-events-none transition-opacity duration-500 min-h-[400px]">
                <h2 class="text-base font-semibold text-secondary mb-3 text-center">好汉姓名</h2>
                <div class="grid grid-cols-5 gap-2 min-h-[350px]">
                    <!-- 姓名卡片将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <!-- 右侧：江湖别称卡片区域 -->
            <div id="symbolContainer" class="opacity-50 pointer-events-none transition-opacity duration-500 min-h-[400px]">
                <h2 class="text-base font-semibold text-primary mb-3 text-center">江湖别称</h2>
                <div class="grid grid-cols-5 gap-2 min-h-[350px]">
                    <!-- 别称卡片将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
        
        <!-- 游戏结束弹窗 -->
        <div id="gameOverModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-3 transform transition-all duration-300 scale-95 opacity-0" id="modalContent">
                <div class="text-center mb-3">
                    <div id="gameOverIcon" class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-green-100 mb-3">
                        <i class="fa fa-trophy text-2xl text-yellow-500"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800 mb-1.5" id="gameOverTitle">恭喜你！</h2>
                    <p class="text-gray-600" id="completionText">你已完成所有好汉的匹配</p>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <div id="finalTimeContainer" class="flex justify-between mb-2 pb-2 border-b border-gray-100">
                        <span class="text-gray-600">用时/剩余时间:</span>
                        <span id="finalTime" class="font-semibold text-gray-800">00:00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">尝试次数:</span>
                        <span id="finalAttempts" class="font-semibold text-gray-800">0</span>
                    </div>
                    <div class="flex justify-between mt-2 pt-2 border-t border-gray-100">
                        <span class="text-gray-600">好汉数量:</span>
                        <span id="finalHeroCount" class="font-semibold text-gray-800">0</span>
                    </div>
                </div>
                
                <div class="flex flex-col gap-2">
                    <button id="closeResultBtn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 focus:outline-none">
                        返回主页
                    </button>
                    <button id="playAgainBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 focus:outline-none">
                        再玩一次
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 再玩一次确认弹窗 -->
        <div id="playAgainConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl p-5 max-w-md w-full mx-3 transform transition-all duration-300 scale-95 opacity-0" id="playAgainModalContent">
                <div class="text-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800 mb-2">准备开始新游戏</h2>
                    <p class="text-gray-600">请确认你的游戏设置，然后点击开始</p>
                </div>
                
                <button id="confirmStartBtn" class="w-full bg-primary hover:bg-primary/90 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 focus:outline-none">
                    开始游戏
                </button>
            </div>
        </div>
        
        <!-- 历史记录弹窗 -->
        <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl p-5 max-w-2xl w-full mx-3 max-h-[70vh] overflow-hidden flex flex-col" id="historyModalContent">
                <div class="text-center mb-3">
                    <h2 class="text-lg font-bold text-gray-800 mb-1.5">游戏历史记录</h2>
                    <p class="text-gray-600">所有游戏结果记录（成功/失败）</p>
                </div>
                
                <div class="flex-1 overflow-y-auto mb-4">
                    <div id="historyList" class="space-y-3">
                        <!-- 历史记录将通过JavaScript动态生成 -->
                        <div class="text-center text-gray-500 py-6" id="emptyHistory">
                            暂无历史记录
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button id="exportHistoryBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg shadow-md transition-all duration-300 focus:outline-none">
                        <i class="fa fa-download mr-1"></i> 导出记录
                    </button>
                    <button id="clearHistoryBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-3 rounded-lg shadow-md transition-all duration-300 focus:outline-none">
                        清空记录
                    </button>
                    <button id="closeHistoryBtn" class="flex-1 bg-primary hover:bg-primary/90 text-white font-bold py-2 px-3 rounded-lg shadow-md transition-all duration-300 focus:outline-none">
                        关闭
                    </button>
                </div>
            </div>
        </div>
        
        <footer class="text-center text-gray-500 py-3">
            <p>水浒传108好汉匹配游戏 | 基于中国古典文学名著</p>
        </footer>
    </div>

    <script>
        // 水浒传108好汉数据（姓名与别称）
        const heroes = [
            { name: '宋江', alias: '及时雨' },
            { name: '卢俊义', alias: '玉麒麟' },
            { name: '吴用', alias: '智多星' },
            { name: '公孙胜', alias: '入云龙' },
            { name: '关胜', alias: '大刀' },
            { name: '林冲', alias: '豹子头' },
            { name: '秦明', alias: '霹雳火' },
            { name: '呼延灼', alias: '双鞭' },
            { name: '花荣', alias: '小李广' },
            { name: '柴进', alias: '小旋风' },
            { name: '李应', alias: '扑天雕' },
            { name: '朱仝', alias: '美髯公' },
            { name: '鲁智深', alias: '花和尚' },
            { name: '武松', alias: '行者' },
            { name: '董平', alias: '双枪将' },
            { name: '张清', alias: '没羽箭' },
            { name: '杨志', alias: '青面兽' },
            { name: '徐宁', alias: '金枪手' },
            { name: '索超', alias: '急先锋' },
            { name: '戴宗', alias: '神行太保' },
            { name: '刘唐', alias: '赤发鬼' },
            { name: '李逵', alias: '黑旋风' },
            { name: '史进', alias: '九纹龙' },
            { name: '穆弘', alias: '没遮拦' },
            { name: '雷横', alias: '插翅虎' },
            { name: '李俊', alias: '混江龙' },
            { name: '阮小二', alias: '立地太岁' },
            { name: '张横', alias: '船火儿' },
            { name: '阮小五', alias: '短命二郎' },
            { name: '张顺', alias: '浪里白条' },
            { name: '阮小七', alias: '活阎罗' },
            { name: '杨雄', alias: '病关索' },
            { name: '石秀', alias: '拼命三郎' },
            { name: '解珍', alias: '两头蛇' },
            { name: '解宝', alias: '双尾蝎' },
            { name: '燕青', alias: '浪子' },
            { name: '朱武', alias: '神机军师' },
            { name: '黄信', alias: '镇三山' },
            { name: '孙立', alias: '病尉迟' },
            { name: '宣赞', alias: '丑郡马' },
            { name: '郝思文', alias: '井木犴' },
            { name: '韩滔', alias: '百胜将' },
            { name: '彭玘', alias: '天目将' },
            { name: '单廷圭', alias: '圣水将' },
            { name: '魏定国', alias: '神火将' },
            { name: '萧让', alias: '圣手书生' },
            { name: '裴宣', alias: '铁面孔目' },
            { name: '欧鹏', alias: '摩云金翅' },
            { name: '邓飞', alias: '火眼狻猊' },
            { name: '燕顺', alias: '锦毛虎' },
            { name: '杨林', alias: '锦豹子' },
            { name: '凌振', alias: '轰天雷' },
            { name: '蒋敬', alias: '神算子' },
            { name: '吕方', alias: '小温侯' },
            { name: '郭盛', alias: '赛仁贵' },
            { name: '安道全', alias: '神医' },
            { name: '皇甫端', alias: '紫髯伯' },
            { name: '王英', alias: '矮脚虎' },
            { name: '扈三娘', alias: '一丈青' },
            { name: '鲍旭', alias: '丧门神' },
            { name: '樊瑞', alias: '混世魔王' },
            { name: '孔明', alias: '毛头星' },
            { name: '孔亮', alias: '独火星' },
            { name: '项充', alias: '八臂哪吒' },
            { name: '李衮', alias: '飞天大圣' },
            { name: '金大坚', alias: '玉臂匠' },
            { name: '马麟', alias: '铁笛仙' },
            { name: '童威', alias: '出洞蛟' },
            { name: '童猛', alias: '翻江蜃' },
            { name: '孟康', alias: '玉幡竿' },
            { name: '侯健', alias: '通臂猿' },
            { name: '陈达', alias: '跳涧虎' },
            { name: '杨春', alias: '白花蛇' },
            { name: '郑天寿', alias: '白面郎君' },
            { name: '陶宗旺', alias: '九尾龟' },
            { name: '宋清', alias: '铁扇子' },
            { name: '乐和', alias: '铁叫子' },
            { name: '龚旺', alias: '花项虎' },
            { name: '丁得孙', alias: '中箭虎' },
            { name: '穆春', alias: '小遮拦' },
            { name: '曹正', alias: '操刀鬼' },
            { name: '宋万', alias: '云里金刚' },
            { name: '杜迁', alias: '摸着天' },
            { name: '薛永', alias: '病大虫' },
            { name: '施恩', alias: '金眼彪' },
            { name: '李忠', alias: '打虎将' },
            { name: '周通', alias: '小霸王' },
            { name: '汤隆', alias: '金钱豹子' },
            { name: '杜兴', alias: '鬼脸儿' },
            { name: '邹渊', alias: '出林龙' },
            { name: '邹润', alias: '独角龙' },
            { name: '朱贵', alias: '旱地忽律' },
            { name: '朱富', alias: '笑面虎' },
            { name: '蔡福', alias: '铁臂膊' },
            { name: '蔡庆', alias: '一枝花' },
            { name: '李立', alias: '催命判官' },
            { name: '李云', alias: '青眼虎' },
            { name: '焦挺', alias: '没面目' },
            { name: '石勇', alias: '石将军' },
            { name: '孙新', alias: '小尉迟' },
            { name: '顾大嫂', alias: '母大虫' },
            { name: '张青', alias: '菜园子' },
            { name: '孙二娘', alias: '母夜叉' },
            { name: '王定六', alias: '活闪婆' },
            { name: '郁保四', alias: '险道神' },
            { name: '白胜', alias: '白日鼠' },
            { name: '时迁', alias: '鼓上蚤' },
            { name: '段景住', alias: '金毛犬' }
        ];

        // 游戏状态
        const gameState = {
            isPlaying: false,
            selectedCards: [],
            matchedPairs: 0,
            totalPairs: 0, // 将由用户选择
            attempts: 0,
            timer: null,
            seconds: 0,
            countdownSeconds: 0, // 倒计时剩余秒数
            originalCountdown: 0, // 初始倒计时秒数
            timingMode: 'timed', // 计时模式：timed/countdown/untimed
            currentHeroes: [], // 当前游戏使用的好汉
            gameStartTime: null, // 游戏开始时间戳
            isReset: false // 标记游戏是否已重置
        };

        // DOM 元素
        const nameContainer = document.getElementById('nameContainer').querySelector('div');
        const aliasContainer = document.getElementById('symbolContainer').querySelector('div');
        const startBtn = document.getElementById('startBtn');
        const historyBtn = document.getElementById('historyBtn');
        const timerDisplay = document.getElementById('timer');
        const timerLabel = document.getElementById('timerLabel');
        const timerContainer = document.getElementById('timerContainer');
        const attemptsDisplay = document.getElementById('attempts');
        const matchesDisplay = document.getElementById('matches');
        const gameOverModal = document.getElementById('gameOverModal');
        const modalContent = document.getElementById('modalContent');
        const finalTime = document.getElementById('finalTime');
        const finalTimeContainer = document.getElementById('finalTimeContainer');
        const finalAttempts = document.getElementById('finalAttempts');
        const finalHeroCount = document.getElementById('finalHeroCount');
        const playAgainBtn = document.getElementById('playAgainBtn');
        const closeResultBtn = document.getElementById('closeResultBtn');
        const heroCountSelect = document.getElementById('heroCount');
        const timingModeSelect = document.getElementById('timingMode');
        const countdownSettings = document.getElementById('countdownSettings');
        const countdownDuration = document.getElementById('countdownDuration');
        const completionText = document.getElementById('completionText');
        const gameOverTitle = document.getElementById('gameOverTitle');
        const gameOverIcon = document.getElementById('gameOverIcon');
        const historyModal = document.getElementById('historyModal');
        const historyModalContent = document.getElementById('historyModalContent');
        const historyList = document.getElementById('historyList');
        const emptyHistory = document.getElementById('emptyHistory');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const closeHistoryBtn = document.getElementById('closeHistoryBtn');
        const playAgainConfirmModal = document.getElementById('playAgainConfirmModal');
        const playAgainModalContent = document.getElementById('playAgainModalContent');
        const confirmStartBtn = document.getElementById('confirmStartBtn');
        const exportHistoryBtn = document.getElementById('exportHistoryBtn'); // 新增：导出按钮

        // 事件监听器
        startBtn.addEventListener('click', handleStartButton);
        playAgainBtn.addEventListener('click', showPlayAgainConfirm);
        closeResultBtn.addEventListener('click', closeGameResult);
        confirmStartBtn.addEventListener('click', startNewGameFromConfirm);
        historyBtn.addEventListener('click', showHistory);
        closeHistoryBtn.addEventListener('click', hideHistory);
        clearHistoryBtn.addEventListener('click', clearHistory);
        timingModeSelect.addEventListener('change', toggleCountdownSettings);
        exportHistoryBtn.addEventListener('click', exportHistoryToCSV); // 新增：导出事件

        // 初始化页面
        function init() {
            toggleCountdownSettings();
            loadHistory();
        }

        // 显示再玩一次确认弹窗
        function showPlayAgainConfirm() {
            // 隐藏游戏结果弹窗
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                gameOverModal.classList.add('hidden');
                
                // 显示确认弹窗
                playAgainConfirmModal.classList.remove('hidden');
                setTimeout(() => {
                    playAgainModalContent.classList.remove('scale-95', 'opacity-0');
                    playAgainModalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            }, 300);
        }

        // 从确认弹窗开始新游戏
        function startNewGameFromConfirm() {
            // 隐藏确认弹窗
            playAgainModalContent.classList.remove('scale-100', 'opacity-100');
            playAgainModalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                playAgainConfirmModal.classList.add('hidden');
                startGame();
            }, 300);
        }

        // 关闭游戏结果弹窗，返回主页
        function closeGameResult() {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                gameOverModal.classList.add('hidden');
                resetGameState();
            }, 300);
        }

        // 处理开始按钮点击
        function handleStartButton() {
            if (gameState.isReset || !gameState.isPlaying) {
                // 如果游戏已重置或未开始，则开始新游戏
                startGame();
            } else {
                // 否则重置游戏
                resetGameState();
            }
        }

        // 切换倒计时设置显示状态
        function toggleCountdownSettings() {
            if (timingModeSelect.value === 'countdown') {
                countdownSettings.classList.remove('hidden');
            } else {
                countdownSettings.classList.add('hidden');
            }
        }

        // 开始游戏
        function startGame() {
            // 获取用户选择的参数
            const selectedCount = parseInt(heroCountSelect.value);
            const selectedTimingMode = timingModeSelect.value;
            const selectedCountdown = parseInt(countdownDuration.value);
            
            // 验证倒计时值
            if (selectedTimingMode === 'countdown' && (isNaN(selectedCountdown) || selectedCountdown < 30)) {
                alert('请设置至少30秒的倒计时');
                return;
            }
            
            // 重置游戏状态
            resetGameState(true);
            
            // 设置游戏参数
            gameState.totalPairs = selectedCount;
            gameState.timingMode = selectedTimingMode;
            gameState.originalCountdown = selectedCountdown;
            gameState.countdownSeconds = selectedCountdown;
            matchesDisplay.textContent = `0/${gameState.totalPairs}`;
            
            // 记录游戏开始时间
            gameState.gameStartTime = new Date();
            
            // 显示或隐藏计时器并更新标签
            if (gameState.timingMode === 'untimed') {
                timerContainer.classList.add('hidden');
                finalTimeContainer.classList.add('hidden');
            } else {
                timerContainer.classList.remove('hidden');
                finalTimeContainer.classList.remove('hidden');
                
                // 更新计时器标签
                if (gameState.timingMode === 'countdown') {
                    timerLabel.textContent = '剩余时间: ';
                    updateTimerDisplay(); // 显示初始倒计时
                } else {
                    timerLabel.textContent = '已用时间: ';
                    timerDisplay.classList.remove('timer-warning');
                }
            }
            
            // 从好汉列表中随机选择指定数量
            gameState.currentHeroes = selectRandomHeroes(selectedCount);
            
            // 启用游戏区域
            nameContainer.parentElement.classList.remove('opacity-50', 'pointer-events-none');
            aliasContainer.parentElement.classList.remove('opacity-50', 'pointer-events-none');
            
            // 创建卡片对 - 姓名在左，别称在右
            createNameCards();
            createAliasCards();
            
            // 添加卡片进入动画
            setTimeout(() => {
                const cards = document.querySelectorAll('.game-card');
                cards.forEach((card, index) => {
                    setTimeout(() => {
                        card.classList.add('opacity-100', 'translate-y-0');
                        card.classList.remove('opacity-0', 'translate-y-4');
                    }, index * 20);
                });
            }, 100);
            
            // 开始计时（根据选择的模式）
            if (gameState.timingMode === 'timed') {
                startStopwatch();
            } else if (gameState.timingMode === 'countdown') {
                startCountdown();
            }
            
            // 更新按钮文本
            startBtn.textContent = '重置游戏';
            
            // 游戏开始
            gameState.isPlaying = true;
            gameState.isReset = false;
        }

        // 从好汉列表中选择随机好汉
        function selectRandomHeroes(count) {
            // 复制好汉数组并打乱顺序
            const shuffled = [...heroes].sort(() => 0.5 - Math.random());
            
            // 返回前count个好汉
            return shuffled.slice(0, count);
        }

        // 创建姓名卡片（左侧）
        function createNameCards() {
            // 清空容器
            nameContainer.innerHTML = '';
            
            // 为每个好汉创建姓名卡片
            gameState.currentHeroes.forEach(hero => {
                const card = {
                    type: 'name',
                    content: hero.name,
                    id: `name-${hero.name}`,
                    heroId: hero.name // 用于匹配的唯一标识
                };
                
                createCardElement(card, nameContainer);
            });
        }

        // 创建别称卡片（右侧）
        function createAliasCards() {
            // 清空容器
            aliasContainer.innerHTML = '';
            
            // 打乱好汉顺序再创建别称卡片，增加难度
            const shuffledHeroes = [...gameState.currentHeroes].sort(() => 0.5 - Math.random());
            
            // 为每个好汉创建别称卡片
            shuffledHeroes.forEach(hero => {
                const card = {
                    type: 'alias',
                    content: hero.alias,
                    id: `alias-${hero.name}`,
                    heroId: hero.name // 用于匹配的唯一标识
                };
                
                createCardElement(card, aliasContainer);
            });
        }

        // 重置游戏状态
        function resetGameState(softReset = false) {
            // 清空游戏容器
            nameContainer.innerHTML = '';
            aliasContainer.innerHTML = '';
            
            // 重置游戏状态
            gameState.isPlaying = false;
            gameState.selectedCards = [];
            gameState.matchedPairs = 0;
            gameState.attempts = 0;
            gameState.seconds = 0;
            gameState.countdownSeconds = 0;
            gameState.gameStartTime = null;
            
            // 重置显示
            attemptsDisplay.textContent = '0';
            timerDisplay.textContent = '00:00';
            timerDisplay.classList.remove('timer-warning');
            
            // 清除计时器
            if (gameState.timer) {
                clearInterval(gameState.timer);
                gameState.timer = null;
            }
            
            // 隐藏模态框
            gameOverModal.classList.add('hidden');
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            // 如果不是软重置（即用户主动点击重置按钮）
            if (!softReset) {
                // 禁用游戏区域
                nameContainer.parentElement.classList.add('opacity-50', 'pointer-events-none');
                aliasContainer.parentElement.classList.add('opacity-50', 'pointer-events-none');
                
                // 更新按钮文本
                startBtn.textContent = '开始游戏';
                
                // 标记为已重置
                gameState.isReset = true;
            }
        }

        // 创建卡片元素 - 调整尺寸防止重叠
        function createCardElement(card, container) {
            const cardElement = document.createElement('div');
            // 增加卡片高度，减小内边距，确保内容不溢出
            cardElement.className = 'game-card w-full h-[70px] rounded-lg shadow-md flex items-center justify-center p-1 transition-all duration-300 cursor-pointer opacity-0 translate-y-4 border-2 bg-white text-gray-800 overflow-hidden';
            cardElement.dataset.id = card.id;
            cardElement.dataset.heroId = card.heroId;
            cardElement.dataset.type = card.type;
            
            // 为不同类型卡片设置不同背景色
            if (card.type === 'alias') {
                cardElement.classList.add('bg-primary/10', 'border-primary/30');
            } else {
                cardElement.classList.add('bg-secondary/10', 'border-secondary/30');
            }
            
            // 卡片内容（优化字体大小和换行）
            const contentText = document.createElement('div');
            contentText.className = 'text-center font-bold text-xs sm:text-sm break-words max-w-[80%]';
            contentText.textContent = card.content;
            cardElement.appendChild(contentText);
            
            // 添加点击事件
            cardElement.addEventListener('click', () => selectCard(cardElement));
            
            // 添加到指定容器
            container.appendChild(cardElement);
        }

        // 选择卡片
        function selectCard(cardElement) {
            // 如果游戏未开始，不执行任何操作
            if (!gameState.isPlaying) return;
            
            // 如果卡片已经匹配，不执行任何操作
            if (cardElement.classList.contains('matched')) return;
            
            // 如果已经选择了这张卡片，不执行任何操作
            if (gameState.selectedCards.some(card => card.element === cardElement)) return;
            
            // 如果已经选择了两张卡片，不执行任何操作
            if (gameState.selectedCards.length >= 2) return;
            
            // 选中卡片效果 - 调整缩放比例防止重叠
            cardElement.classList.add('card-selected', 'z-10');
            
            // 将卡片添加到已选择列表
            gameState.selectedCards.push({
                element: cardElement,
                heroId: cardElement.dataset.heroId,
                type: cardElement.dataset.type
            });
            
            // 如果选择了两张卡片，检查是否匹配
            if (gameState.selectedCards.length === 2) {
                // 确保选择的是不同类型的卡片（一个别称和一个姓名）
                if (gameState.selectedCards[0].type !== gameState.selectedCards[1].type) {
                    checkForMatch();
                    
                    // 增加尝试次数
                    gameState.attempts++;
                    attemptsDisplay.textContent = gameState.attempts;
                } else {
                    // 选择了同一类型的卡片，自动取消选择
                    setTimeout(() => {
                        gameState.selectedCards.forEach(card => {
                            card.element.classList.remove('card-selected', 'z-10');
                        });
                        gameState.selectedCards = [];
                    }, 500);
                }
            }
        }

        // 检查是否匹配
        function checkForMatch() {
            const [card1, card2] = gameState.selectedCards;
            
            // 检查是否是同一好汉的不同类型卡片
            if (card1.heroId === card2.heroId) {
                // 匹配成功
                setTimeout(() => {
                    // 添加匹配成功效果
                    card1.element.classList.add('matched', 'card-matched', 'ring-2', 'ring-green-500', 'bg-green-50');
                    card2.element.classList.add('matched', 'card-matched', 'ring-2', 'ring-green-500', 'bg-green-50');
                    
                    // 移除选中效果但保持z-index
                    card1.element.classList.remove('card-selected');
                    card2.element.classList.remove('card-selected');
                    
                    // 移除点击事件
                    card1.element.style.pointerEvents = 'none';
                    card2.element.style.pointerEvents = 'none';
                    
                    // 增加匹配计数
                    gameState.matchedPairs++;
                    matchesDisplay.textContent = `${gameState.matchedPairs}/${gameState.totalPairs}`;
                    
                    // 清空选中的卡片
                    gameState.selectedCards = [];
                    
                    // 检查游戏是否结束
                    if (gameState.matchedPairs === gameState.totalPairs) {
                        endGame(true);
                    }
                }, 500);
            } else {
                // 匹配失败
                setTimeout(() => {
                    // 添加匹配失败效果
                    card1.element.classList.add('ring-2', 'ring-red-500', 'bg-red-50');
                    card2.element.classList.add('ring-2', 'ring-red-500', 'bg-red-50');
                    
                    // 短暂延迟后移除选中效果
                    setTimeout(() => {
                        card1.element.classList.remove('card-selected', 'ring-2', 'ring-red-500', 'bg-red-50', 'z-10');
                        card2.element.classList.remove('card-selected', 'ring-2', 'ring-red-500', 'bg-red-50', 'z-10');
                        
                        // 清空选中的卡片
                        gameState.selectedCards = [];
                    }, 500);
                }, 500);
            }
        }

        // 开始秒表计时（计时模式）
        function startStopwatch() {
            gameState.seconds = 0;
            updateTimerDisplay();
            
            gameState.timer = setInterval(() => {
                gameState.seconds++;
                updateTimerDisplay();
            }, 1000);
        }

        // 开始倒计时（倒计时模式）
        function startCountdown() {
            updateTimerDisplay();
            
            gameState.timer = setInterval(() => {
                gameState.countdownSeconds--;
                
                // 当剩余时间少于10秒时添加警告动画
                if (gameState.countdownSeconds <= 10) {
                    timerDisplay.classList.add('timer-warning');
                }
                
                updateTimerDisplay();
                
                // 倒计时结束
                if (gameState.countdownSeconds <= 0) {
                    clearInterval(gameState.timer);
                    endGame(false);
                }
            }, 1000);
        }

        // 更新计时器显示
        function updateTimerDisplay() {
            let seconds, minutes;
            
            if (gameState.timingMode === 'countdown') {
                // 倒计时模式
                seconds = gameState.countdownSeconds % 60;
                minutes = Math.floor(gameState.countdownSeconds / 60);
            } else {
                // 计时模式
                seconds = gameState.seconds % 60;
                minutes = Math.floor(gameState.seconds / 60);
            }
            
            // 格式化显示
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // 游戏结束
        function endGame(isSuccess) {
            // 停止计时器
            if (gameState.timer) {
                clearInterval(gameState.timer);
                gameState.timer = null;
            }
            
            // 游戏结束状态
            gameState.isPlaying = false;
            
            // 更新游戏结果弹窗内容
            if (isSuccess) {
                // 游戏成功
                gameOverIcon.className = 'inline-flex items-center justify-center w-12 h-12 rounded-full bg-green-100 mb-3';
                gameOverIcon.innerHTML = '<i class="fa fa-trophy text-2xl text-yellow-500"></i>';
                gameOverTitle.textContent = '恭喜你！';
                completionText.textContent = '你已完成所有好汉的匹配';
                
                // 保存游戏记录
                saveGameHistory(true);
            } else {
                // 游戏失败（倒计时结束）
                gameOverIcon.className = 'inline-flex items-center justify-center w-12 h-12 rounded-full bg-red-100 mb-3';
                gameOverIcon.innerHTML = '<i class="fa fa-times-circle text-2xl text-red-500"></i>';
                gameOverTitle.textContent = '时间到！';
                completionText.textContent = '很遗憾，未能完成所有匹配';
                
                // 保存游戏记录
                saveGameHistory(false);
            }
            
            // 更新最终统计数据
            finalHeroCount.textContent = gameState.totalPairs;
            finalAttempts.textContent = gameState.attempts;
            
            // 更新最终时间显示
            if (gameState.timingMode === 'countdown') {
                if (isSuccess) {
                    finalTime.textContent = `${Math.floor(gameState.countdownSeconds / 60).toString().padStart(2, '0')}:${(gameState.countdownSeconds % 60).toString().padStart(2, '0')} (剩余)`;
                } else {
                    finalTime.textContent = '00:00 (已用完)';
                }
            } else if (gameState.timingMode === 'timed') {
                finalTime.textContent = `${Math.floor(gameState.seconds / 60).toString().padStart(2, '0')}:${(gameState.seconds % 60).toString().padStart(2, '0')}`;
            }
            
            // 显示游戏结果弹窗
            gameOverModal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
            
            // 更新按钮文本
            startBtn.textContent = '开始游戏';
        }

        // 保存游戏历史记录
        function saveGameHistory(isSuccess) {
            // 获取现有历史记录
            let history = JSON.parse(localStorage.getItem('heroMatchHistory') || '[]');
            
            // 计算用时（秒）
            let timeSpent = 0;
            if (gameState.timingMode === 'timed') {
                timeSpent = gameState.seconds;
            } else if (gameState.timingMode === 'countdown') {
                timeSpent = gameState.originalCountdown - gameState.countdownSeconds;
            }
            
            // 创建新记录
            const newRecord = {
                id: Date.now(), // 使用时间戳作为唯一ID
                date: new Date().toISOString(),
                heroCount: gameState.totalPairs,
                attempts: gameState.attempts,
                timeSpent: timeSpent,
                timingMode: gameState.timingMode,
                isSuccess: isSuccess
            };
            
            // 添加到历史记录
            history.unshift(newRecord); // 添加到开头
            
            // 限制历史记录数量（最多100条）
            if (history.length > 100) {
                history = history.slice(0, 100);
            }
            
            // 保存到本地存储
            localStorage.setItem('heroMatchHistory', JSON.stringify(history));
            
            // 更新历史记录显示
            loadHistory();
        }

        // 加载历史记录
        function loadHistory() {
            // 获取历史记录
            const history = JSON.parse(localStorage.getItem('heroMatchHistory') || '[]');
            
            // 清空历史记录列表
            historyList.innerHTML = '';
            
            // 检查是否有历史记录
            if (history.length === 0) {
                historyList.innerHTML = '<div class="text-center text-gray-500 py-6" id="emptyHistory">暂无历史记录</div>';
                return;
            }
            
            // 隐藏空历史提示
            emptyHistory.classList.add('hidden');
            
            // 添加历史记录项
            history.forEach(record => {
                const recordElement = document.createElement('div');
                recordElement.className = 'bg-gray-50 rounded-lg p-3 border border-gray-100 hover:shadow-md transition-shadow';
                
                // 格式化日期
                const date = new Date(record.date);
                const formattedDate = date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // 格式化时间
                let timeDisplay = '';
                if (record.timingMode === 'untimed') {
                    timeDisplay = '无计时';
                } else {
                    const minutes = Math.floor(record.timeSpent / 60);
                    const seconds = record.timeSpent % 60;
                    timeDisplay = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    if (record.timingMode === 'countdown') {
                        timeDisplay += ' (用时)';
                    }
                }
                
                // 成功/失败状态样式
                const statusClass = record.isSuccess ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50';
                const statusText = record.isSuccess ? '成功' : '失败';
                
                // 设置记录内容
                recordElement.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium">${formattedDate}</span>
                        <span class="text-xs px-2 py-0.5 rounded-full ${statusClass}">${statusText}</span>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mt-2 text-sm">
                        <div>
                            <span class="text-gray-500">好汉数量:</span>
                            <span class="font-medium ml-1">${record.heroCount}</span>
                        </div>
                        <div>
                            <span class="text-gray-500">尝试次数:</span>
                            <span class="font-medium ml-1">${record.attempts}</span>
                        </div>
                        <div>
                            <span class="text-gray-500">用时:</span>
                            <span class="font-medium ml-1">${timeDisplay}</span>
                        </div>
                    </div>
                `;
                
                // 添加到历史记录列表
                historyList.appendChild(recordElement);
            });
        }

        // 显示历史记录
        function showHistory() {
            historyModal.classList.remove('hidden');
            setTimeout(() => {
                historyModalContent.classList.remove('scale-95', 'opacity-0');
                historyModalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        // 隐藏历史记录
        function hideHistory() {
            historyModalContent.classList.remove('scale-100', 'opacity-100');
            historyModalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                historyModal.classList.add('hidden');
            }, 300);
        }

        // 清空历史记录
        function clearHistory() {
            if (confirm('确定要清空所有历史记录吗？此操作不可恢复。')) {
                localStorage.removeItem('heroMatchHistory');
                loadHistory();
            }
        }

        // 导出历史记录为CSV
        function exportHistoryToCSV() {
            const history = JSON.parse(localStorage.getItem('heroMatchHistory') || '[]');
            
            if (history.length === 0) {
                alert('没有历史记录可导出');
                return;
            }
            
            // CSV表头
            let csvContent = "日期,状态,好汉数量,尝试次数,用时,计时模式\n";
            
            // 遍历历史记录，添加到CSV
            history.forEach(record => {
                const date = new Date(record.date);
                const formattedDate = date.toLocaleString('zh-CN');
                const status = record.isSuccess ? '成功' : '失败';
                const timingMode = record.timingMode === 'timed' ? '计时模式' : 
                                  (record.timingMode === 'countdown' ? '倒计时模式' : '无计时模式');
                
                let timeDisplay = '';
                if (record.timingMode === 'untimed') {
                    timeDisplay = '无计时';
                } else {
                    const minutes = Math.floor(record.timeSpent / 60);
                    const seconds = record.timeSpent % 60;
                    timeDisplay = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
                
                // 处理CSV中的逗号（用双引号包裹）
                csvContent += `"${formattedDate}",${status},${record.heroCount},${record.attempts},"${timeDisplay}",${timingMode}\n`;
            });
            
            // 创建Blob对象
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // 创建下载链接
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            // 设置文件名
            const fileName = `水浒传108好汉匹配游戏历史记录_${new Date().toLocaleDateString().replace(/\//g, '-')}.csv`;
            
            // 设置下载属性
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            
            // 添加到页面并触发下载
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 初始化游戏
        init();
    </script>
</body>
</html>
